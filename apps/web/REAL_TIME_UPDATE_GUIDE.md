# 🚀 Hawk Tracker 实时更新功能指南

## 📋 功能概述

Hawk Tracker 的实时更新功能已经完成，现在可以实时监控和显示四个核心指标：

- **👥 活跃用户数 (UV)** - 独立访客数量
- **📄 页面浏览量 (PV)** - 总页面访问量
- **📈 总事件数** - 所有监控事件总数
- **❌ 错误率** - 错误事件占比

## ✨ 新功能特性

### 🔄 智能实时更新

- **自动刷新**: 每30秒自动获取最新数据
- **手动刷新**: 点击刷新按钮立即更新
- **网络感知**: 自动检测网络状态，离线时暂停更新
- **页面可见性**: 页面重新可见时自动刷新

### 📊 趋势分析

- **实时趋势**: 显示数据变化趋势（上升/下降/稳定）
- **变化百分比**: 显示相对于上次更新的变化百分比
- **视觉指示**: 绿色上升箭头、红色下降箭头、灰色稳定线

### 🛡️ 错误处理

- **自动重试**: 网络错误时自动重试（最多3次）
- **递增间隔**: 重试间隔递增，避免频繁请求
- **状态显示**: 显示重试次数和网络状态
- **超时控制**: 10秒请求超时，避免长时间等待

### 🎯 用户体验

- **加载状态**: 显示数据加载动画
- **错误提示**: 友好的错误信息显示
- **网络状态**: 实时显示网络连接状态
- **更新时间**: 显示最后更新时间

## 🛠️ 技术实现

### 数据获取流程

```typescript
1. 前端请求 → 后端 API
2. 后端返回 → 原始监控数据
3. 前端计算 → PV/UV/错误率
4. 趋势分析 → 与上次数据比较
5. 状态更新 → 更新UI显示
```

### API 端点

- **统计数据**: `GET /api/stats` - 获取总体统计数据
- **行为数据**: `GET /api/data?type=behaviors&limit=1000` - 获取行为数据用于计算PV/UV

### 数据计算逻辑

```typescript
// PV 计算
const pv = behaviors.filter(
  (item) =>
    item.subType === 'load' ||
    item.subType === 'route_change' ||
    item.subType === 'pageView',
).length;

// UV 计算
const uniqueUsers = new Set();
behaviors.forEach((item) => {
  const userInfo = item.data?.baseInfo || item.data?.userInfo || item.data;
  if (userInfo) {
    const userId =
      userInfo.userUuid ||
      userInfo.sdkUserUuid ||
      userInfo.userId ||
      userInfo.sessionId;
    if (userId) {
      uniqueUsers.add(userId);
    }
  }
});

// 错误率计算
const errorRate =
  stats.total > 0 ? ((stats.errors / stats.total) * 100).toFixed(1) : '0.0';
```

## 🧪 测试工具

### 实时更新测试脚本

使用提供的测试脚本来验证实时更新功能：

```bash
# 进入 web 目录
cd apps/web

# 发送单次数据批次
node test-real-time-updates.js --single

# 持续发送数据（默认）
node test-real-time-updates.js --continuous

# 显示帮助信息
node test-real-time-updates.js --help
```

### 测试脚本功能

- **模拟用户行为**: 生成真实的用户行为数据
- **多种事件类型**: 行为、错误、性能事件
- **实时数据发送**: 每5秒发送一批数据
- **指标监控**: 每30秒显示当前指标状态
- **网络模拟**: 模拟真实的网络环境

## 📱 界面说明

### 状态栏

- **🟢 绿色圆点**: 网络连接正常
- **🔴 红色圆点**: 网络连接不可用
- **最后更新时间**: 显示数据最后更新时间
- **自动刷新提示**: 显示刷新间隔
- **网络状态**: 离线时显示网络连接不可用
- **重试次数**: 显示当前重试次数

### 数据卡片

- **指标值**: 大字体显示当前数值
- **趋势图标**: 显示数据变化趋势
- **变化百分比**: 显示相对于上次的变化
- **徽章**: 显示指标类型标识

### 操作按钮

- **刷新按钮**: 手动刷新数据
- **加载状态**: 刷新时显示加载动画
- **禁用状态**: 离线时按钮禁用

## 🔧 配置选项

### 刷新间隔

可以通过修改 `useDashboardMetrics` Hook 中的 `refreshInterval` 来调整自动刷新间隔：

```typescript
const [refreshInterval, setRefreshIntervalState] = useState<number>(30000); // 30秒
```

### 重试配置

- **最大重试次数**: 3次
- **重试间隔**: 递增间隔（2秒、4秒、6秒）
- **超时时间**: 10秒

## 🚨 故障排除

### 常见问题

1. **数据不更新**
   - 检查网络连接
   - 确认后端服务运行在 `http://localhost:3001`
   - 查看浏览器控制台错误信息

2. **显示"网络连接不可用"**
   - 检查网络连接
   - 确认后端服务状态
   - 尝试手动刷新

3. **数据计算错误**
   - 检查后端返回的数据格式
   - 确认用户标识字段正确
   - 查看浏览器控制台日志

### 调试方法

1. **浏览器开发者工具**
   - 查看 Network 标签页的 API 请求
   - 检查 Console 标签页的错误信息
   - 使用 React DevTools 查看组件状态

2. **测试脚本**
   - 使用测试脚本验证后端 API
   - 检查数据发送和接收状态
   - 监控指标变化

## 📈 性能优化

### 前端优化

- **防抖处理**: 避免频繁的 API 请求
- **缓存机制**: 缓存上次的数据用于趋势计算
- **条件渲染**: 只在数据变化时更新 UI
- **内存管理**: 及时清理定时器和事件监听器

### 后端优化

- **数据聚合**: 后端预计算统计数据
- **分页查询**: 限制返回数据量
- **缓存策略**: 缓存热点数据
- **索引优化**: 优化数据库查询性能

## 🎯 下一步计划

1. **实时推送**: 使用 WebSocket 实现真正的实时推送
2. **数据可视化**: 添加图表和趋势图
3. **告警功能**: 设置阈值告警
4. **历史数据**: 查看历史趋势数据
5. **多项目支持**: 支持多个项目的监控

---

## 📞 技术支持

如果在使用过程中遇到问题，请：

1. 查看浏览器控制台错误信息
2. 检查网络连接和后端服务状态
3. 使用测试脚本验证功能
4. 查看本文档的故障排除部分

实时更新功能现在已经完全可用，可以为您提供实时的监控数据！
